import pandas as pd
import numpy as np
import torch
import torch.nn as nn
import torch.optim as optim
import matplotlib.pyplot as plt

# === ãƒ•ã‚¡ã‚¤ãƒ«ãƒ‘ã‚¹ ===
AU_CSV_PATH = "/Users/yamashita_yuma/Documents/AI_Sem/project/output/frames.csv"
COMMENT_CSV_PATH = "/Users/yamashita_yuma/Documents/AI_Sem/comment_counts.csv"

# === ãƒã‚¤ãƒ‘ãƒ¼ãƒ‘ãƒ©ãƒ¡ãƒ¼ã‚¿ ===
learning_rate = 0.1
num_epochs = 5000
penalty_weight = -0.2
n_trials = 20

# === ãƒ‡ãƒ¼ã‚¿èª­ã¿è¾¼ã¿ ===
df_au = pd.read_csv(AU_CSV_PATH)
df_comment = pd.read_csv(COMMENT_CSV_PATH)
df_comment.columns = ["time", "comments"]

# === AUã®å¯¾è±¡åˆ—ï¼ˆ7ç¨®ï¼‰===
target_aus = ['AU02_r', 'AU06_r', 'AU07_r', 'AU09_r', 'AU10_r', 'AU12_r', 'AU25_r']
au_data_all = df_au[target_aus].fillna(0).reset_index(drop=True)
success_flags = df_au['success'].reset_index(drop=True).values

# === ã‚³ãƒ¡ãƒ³ãƒˆæ•°ï¼š10ç§’ã”ã¨ã®å€¤ã‚’10å€ã«å±•é–‹ï¼ˆ1ç§’ã”ã¨ã«åŒã˜å€¤ã‚’ç¹°ã‚Šè¿”ã™ï¼‰===
comment_counts_raw = df_comment["comments"].astype(float).values
comment_counts_expanded = np.repeat(comment_counts_raw, 10)  # å„ã‚³ãƒ¡ãƒ³ãƒˆå€¤ã‚’10å›ç¹°ã‚Šè¿”ã—ï¼ˆ10fpsï¼‰

# === é•·ã•ã®æƒãˆå‡¦ç† ===
min_len = min(len(au_data_all), len(comment_counts_expanded))
au_data_all = au_data_all.iloc[:min_len]
success_flags = success_flags[:min_len]
comment_counts_expanded = comment_counts_expanded[:min_len]
max_comments = np.max(comment_counts_expanded)

# === TensoråŒ– ===
X = torch.tensor(au_data_all.values, dtype=torch.float32)
y = torch.tensor(comment_counts_expanded, dtype=torch.float32)

# === ãƒ¢ãƒ‡ãƒ«å®šç¾© ===
class AULinearScorer(nn.Module):
    def __init__(self, dim):
        super().__init__()
        self.weights = nn.Parameter(torch.randn(dim))
    def forward(self, x):
        return (x * self.weights).sum(dim=1)

# === è¤‡æ•°å›ã®å­¦ç¿’ã§å¹³å‡é‡ã¿ã‚’å–å¾— ===
all_weights = []
for trial in range(n_trials):
    model = AULinearScorer(X.shape[1])
    optimizer = optim.Adam(model.parameters(), lr=learning_rate)

    for epoch in range(num_epochs):
        optimizer.zero_grad()
        pred_scores = model(X)
        pred_scores = pred_scores / pred_scores.max()

        reward = pred_scores * (y / max_comments)
        reward[:400] *= penalty_weight  # åˆæœŸ40ç§’ï¼ˆ10fpsÃ—40ï¼‰ã«ãƒšãƒŠãƒ«ãƒ†ã‚£

        loss = -reward.mean()
        loss.backward()
        optimizer.step()

    all_weights.append(model.weights.detach().numpy())

# === å¹³å‡é‡ã¿ç®—å‡º ===
mean_weights = np.mean(np.array(all_weights), axis=0)
print("ğŸ¯ å¹³å‡åŒ–ã•ã‚ŒãŸé‡ã¿:", mean_weights)

# === é‡ã¿ã§AUã‚¹ã‚³ã‚¢ã‚’ç®—å‡º ===
frame_scores = np.dot(au_data_all.values, mean_weights)

# === success=0 ã®ç®‡æ‰€ã¯å‰ã®å€¤ã‚’å¼•ãç¶™ã ===
frame_scores_masked = frame_scores.copy()
for i in range(1, len(frame_scores_masked)):
    if success_flags[i] == 0:
        frame_scores_masked[i] = frame_scores_masked[i-1]

# === ã‚°ãƒ©ãƒ•æç”» ===
plt.figure(figsize=(15, 5))
plt.plot(df_au['frame'][:len(frame_scores_masked)], frame_scores_masked, label="AU Score (Avg Weights)", color='blue')
plt.xlabel("Frame Number")
plt.ylabel("AU-Based Score")
plt.title("AU-Based Score with Averaged Weights (Masked by success, forward-filled)")
plt.grid(True)
plt.legend()
plt.tight_layout()
plt.show()

# === æœ‰åŠ¹ã‚¹ã‚³ã‚¢ã®ã¿ã‚’æŠ½å‡ºï¼ˆ0ã‚’é™¤å¤–ï¼‰ ===
valid_scores = frame_scores_masked[frame_scores_masked > 0]

# === å¹³å‡ã¨æ¨™æº–åå·®ã‚’æœ‰åŠ¹ãªéƒ¨åˆ†ã‹ã‚‰ç®—å‡º ===
mean_valid = np.mean(valid_scores)
std_valid = np.std(valid_scores)

# === Zã‚¹ã‚³ã‚¢ã‚’å†è¨ˆç®—ï¼ˆå…¨ä½“ã«å¯¾ã—ã¦ã€ãŸã ã—0ã¯ãã®ã¾ã¾ï¼‰ ===
z_scores = np.where(
    frame_scores_masked > 0,
    (frame_scores_masked - mean_valid) / std_valid,
    0  # ç„¡åŠ¹ã‚¹ã‚³ã‚¢ï¼ˆ0ï¼‰ã¯ãã®ã¾ã¾
)

# === Zã‚¹ã‚³ã‚¢ã®ã‚°ãƒ©ãƒ•æç”» ===
plt.figure(figsize=(15, 3))
plt.plot(df_au['frame'][:len(z_scores)], z_scores, color='purple', label='Z-score (Valid-based)')
plt.axhline(y=0, color='red', linestyle='--', label='Threshold = 0')
plt.xlabel("Frame Number")
plt.ylabel("Z-score")
plt.title("Z-Score of AU-Based Score (excluding 0s in mean/std)")
plt.legend()
plt.grid(True)
plt.tight_layout()
plt.show()

# === ãƒ‘ãƒ©ãƒ¡ãƒ¼ã‚¿è¨­å®š ===
window_size = 60       # 30ãƒ•ãƒ¬ãƒ¼ãƒ 
stride = 10            # 10ãƒ•ãƒ¬ãƒ¼ãƒ 
threshold_percent = 90 # 90%ä»¥ä¸Š

# === å¯¾è±¡ï¼šframe_scores_masked ã‹ã‚‰ z_scores ã‚’è¨ˆç®—æ¸ˆã¿ã¨ã—ã¦
frame_numbers = df_au['frame'].values[:len(z_scores)]

print("âœ… è©²å½“ã™ã‚‹åŒºé–“ï¼ˆZã‚¹ã‚³ã‚¢ > 0 ãŒ {:.0f}% ä»¥ä¸Šï¼‰:".format(threshold_percent))
for start in range(0, len(z_scores) - window_size + 1, stride):
    end = start + window_size
    window = z_scores[start:end]

    # Zã‚¹ã‚³ã‚¢ > 0 ã®å‰²åˆï¼ˆ0ã‚’å«ã‚ã‚‹è©•ä¾¡ï¼‰
    ratio = (window > 0).sum() / window_size * 100

    if ratio >= threshold_percent:
        print(f"  - ãƒ•ãƒ¬ãƒ¼ãƒ  {frame_numbers[start]} ã€œ {frame_numbers[end-1]}ï¼ˆZã‚¹ã‚³ã‚¢ > 0 å‰²åˆ: {ratio:.1f} %ï¼‰")
